<div fxLayoutAlign="center center" class="header-div" fxLayoutGap="50px">
    <mat-spinner *ngIf="(isLoading$ | async)"></mat-spinner>
    <mat-form-field fxFlex="20%" *ngIf="categoriesKeyValue.length > 0 && !(isLoading$ | async)">
        <mat-label> Categories </mat-label>
        <mat-select name="categories" id="categories" [(ngModel)]="category" (selectionChange)="applyFilterByCategory()">
            <mat-option value="All">All</mat-option>
            <mat-option *ngFor="let c of categoriesKeyValue" [value]="c.key">
                {{c.value}}
            </mat-option>
        </mat-select>
    </mat-form-field>
    <mat-form-field fxFlex="20%" *ngIf="datesKeyValue.length > 0 && !(isLoading$ | async)">
        <mat-label> Dates </mat-label>
        <mat-select name="dates" id="dates" [(ngModel)]="paymentDate" (selectionChange)="applyFilterByDate()">
            <mat-option value="All">All</mat-option>
            <mat-option *ngFor="let p of datesKeyValue" [value]="p.key">
                {{p.value}}
            </mat-option>
        </mat-select>
    </mat-form-field>
</div>
<a mat-fab class="add-button" color="accent" *ngIf="!(isLoading$ | async)" [disabled]="allCategories.length === 0"
    [matTooltip]="allCategories.length === 0 ? 'Please, add categories first.' : 'Add Payment'"
    (click)="allCategories.length > 0 && onOpenAddPaymentDialog()"><mat-icon>add</mat-icon></a>
<mat-table *ngIf="!(isLoading$ | async)" [ngClass]="{'mat-table-no-items': dataSource.data.length === 0, 'mat-table-with-items': dataSource.data.length > 0 }" [dataSource]="dataSource" matSort>
    <ng-container matColumnDef="CreatedDate">
        <mat-header-cell *matHeaderCellDef mat-sort-header> Created Date </mat-header-cell>
        <mat-cell *matCellDef="let element"> {{ element.createdDate | date:'dd/MM/yyyy HH:mm':userTimeZone }} </mat-cell>
        <mat-footer-cell *matFooterCellDef> </mat-footer-cell>
    </ng-container>
    <ng-container matColumnDef="Category">
        <mat-header-cell *matHeaderCellDef mat-sort-header> Category </mat-header-cell>
        <mat-cell *matCellDef="let element">
            <span *ngIf="!editPayment?.id || element.id!==editPayment.id">{{ element.categoryName }}</span>
            <mat-form-field *ngIf="editPayment?.id && element.id===editPayment?.id">
                <mat-label> Categories </mat-label>
                <mat-select name="category" id="category" [(ngModel)]="element.categoryId">
                    <mat-option *ngFor="let cat of allCategories" [value]="cat.id">
                        {{cat.name}}
                    </mat-option>
                </mat-select>
            </mat-form-field>
        </mat-cell>

        <mat-footer-cell *matFooterCellDef> </mat-footer-cell>
    </ng-container>
    <ng-container  matColumnDef="Description">
        <mat-header-cell *matHeaderCellDef mat-sort-header> Description </mat-header-cell>
        <mat-cell *matCellDef="let element">
            <span *ngIf="!editPayment?.id || element.id!==editPayment.id">{{ element.description }}</span>
            <mat-form-field *ngIf="editPayment?.id && element.id===editPayment?.id" appearance="outline">
                <input type="text" matInput placeholder="Description" name="description" id="description" [(ngModel)]="element.description">
            </mat-form-field>
        </mat-cell>
        <mat-footer-cell *matFooterCellDef> </mat-footer-cell>
    </ng-container>
    <ng-container matColumnDef="Establishment">
        <mat-header-cell *matHeaderCellDef mat-sort-header> Establishment </mat-header-cell>        
        <mat-cell *matCellDef="let element">
            <span *ngIf="!editPayment?.id || element.id!==editPayment.id">{{ element.establishment }}</span>
            <mat-form-field *ngIf="editPayment?.id && element.id===editPayment?.id" appearance="outline">
                <input type="text" matInput placeholder="Establishment" name="establishment" id="establishment" [(ngModel)]="element.establishment">
            </mat-form-field>
        </mat-cell>
        <mat-footer-cell *matFooterCellDef> </mat-footer-cell>
    </ng-container>
    <ng-container matColumnDef="Price">
        <mat-header-cell *matHeaderCellDef mat-sort-header> Price </mat-header-cell>       
        <mat-cell *matCellDef="let element" fxLayoutGap="15px">
            <span *ngIf="!editPayment?.id || element.id!==editPayment.id">{{ element.price | currency: element.currency }}</span>
            <mat-form-field *ngIf="editPayment?.id && element.id===editPayment?.id" [style.width.px]=60>
                <mat-label> Currency </mat-label>
                <mat-select name="currency" id="currency" [(ngModel)]="element.currency">
                    <mat-option *ngFor="let currency of currencies" [value]="currency">
                        {{currency}}
                    </mat-option>
                </mat-select>
            </mat-form-field>
            <mat-form-field [style.width.px]=80 *ngIf="editPayment?.id && element.id===editPayment?.id" appearance="outline">
                <input type="number" matInput placeholder="Price" name="price" id="price" [(ngModel)]="element.price">
            </mat-form-field>
        </mat-cell>
        <mat-footer-cell *matFooterCellDef> <span style="font-weight: bold; margin-right: 15px;">Total</span> {{ dataSource.filteredData | paymentTotalPrice:userBaseCurrency | currency: userBaseCurrency }} </mat-footer-cell>
    </ng-container>
    <ng-container matColumnDef="Actions">
        <mat-header-cell  *matHeaderCellDef> Actions </mat-header-cell>
        <mat-cell *matCellDef="let element">
            <button mat-icon-button (click)="onDelete(element)" style="color:red;" *ngIf="element.id!==editPayment?.id" matTooltip="Delete">
                <mat-icon>delete</mat-icon>
            </button>
            <button mat-icon-button (click)="onEdit(element)" style="color:blue;" *ngIf="element.id!==editPayment?.id"  matTooltip="Edit">
                <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button (click)="onUpdate()" style="color:green;" *ngIf="element.id===editPayment?.id" matTooltip="Save">
                <mat-icon>save</mat-icon>
            </button>
            <button mat-icon-button (click)="onCancelEdit()" style="color:red;" *ngIf="element.id===editPayment?.id" matTooltip="Cancel edit">
                <mat-icon>clear</mat-icon>
            </button>
        </mat-cell>
        <mat-footer-cell *matFooterCellDef> </mat-footer-cell>
    </ng-container>
    <mat-footer-row *matFooterRowDef="displayedColumns"></mat-footer-row>
    <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
    <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
</mat-table>
<mat-paginator *ngIf="!(isLoading$ | async)" #paginator [pageSize]="10" showFirstLastButtons></mat-paginator>