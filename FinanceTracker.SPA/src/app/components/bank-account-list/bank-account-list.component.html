<div fxLayoutAlign="center center" class="header-div">
    <mat-spinner *ngIf="(isLoading$ | async)"></mat-spinner>
    <mat-form-field fxFlex="20%" *ngIf="!(isLoading$ | async)">
        <input matInput type="text" (keyup)="doFilter($event.target.value)" placeholder="Filter" name="txtFilter" id="txtFilter">
    </mat-form-field>
</div>
<a mat-fab class="add-button" *ngIf="!(isLoading$ | async)" color="accent" (click)="openDialog()"><mat-icon>add</mat-icon></a>
<mat-table *ngIf="!(isLoading$ | async)" [dataSource]="dataSource" matSort>
    <ng-container matColumnDef="CreatedDate">
        <mat-header-cell *matHeaderCellDef mat-sort-header> Created Date </mat-header-cell>
        <mat-cell *matCellDef="let element"> {{ element.createdDate | date:'dd/MM/yyyy hh:mm' }} </mat-cell>
    </ng-container>
    <ng-container  matColumnDef="Name">
        <mat-header-cell *matHeaderCellDef mat-sort-header> Name </mat-header-cell>
        <mat-cell *matCellDef="let element">
            <span *ngIf="!editBankInfo?.id || element.id!==editBankInfo.id">{{ element.name }}</span>
            <mat-form-field *ngIf="editBankInfo?.id && element.id===editBankInfo?.id" appearance="outline">
                <input type="text" matInput placeholder="Name" name="name" id="name" [(ngModel)]="element.name">
            </mat-form-field>
        </mat-cell>
    </ng-container>
    <ng-container  matColumnDef="Branch">
        <mat-header-cell *matHeaderCellDef mat-sort-header> Branch </mat-header-cell>
        <mat-cell *matCellDef="let element">
            <span *ngIf="!editBankInfo?.id || element.id!==editBankInfo.id">{{ element.branch }}</span>
            <mat-form-field *ngIf="editBankInfo?.id && element.id===editBankInfo?.id" appearance="outline">
                <input type="text" matInput placeholder="Branch" name="branch" id="branch" [(ngModel)]="element.branch">
            </mat-form-field>
        </mat-cell>
    </ng-container>
    <ng-container  matColumnDef="Status">
        <mat-header-cell *matHeaderCellDef mat-sort-header> Status </mat-header-cell>
        <mat-cell *matCellDef="let element">
            <mat-slide-toggle  *ngIf="editBankInfo?.id && element.id===editBankInfo?.id" (click)="onIsActiveChange(element)" [(ngModel)]="element.isActive" name="isActive" id="isActive" color="primary"></mat-slide-toggle>
            <span *ngIf="!editBankInfo?.id || element.id!==editBankInfo.id">
                {{ element.isActive ? 'Active' : 'Inactive' }}
            </span>
        </mat-cell>
    </ng-container>
    <ng-container matColumnDef="Actions">
        <mat-header-cell  *matHeaderCellDef> Actions </mat-header-cell>
        <mat-cell *matCellDef="let element">
            <button mat-icon-button (click)="onAddAccout(element)" style="color:blue;" *ngIf="!rowInEditMode && element.isActive" matTooltip="Add account">
                <mat-icon>add_circle_outline</mat-icon>
            </button>
            <button mat-icon-button (click)="onDelete(element)" style="color:red;" *ngIf="!rowInEditMode || element.id!==editBankInfo?.id" matTooltip="Delete all bank accounts">
                <mat-icon>delete</mat-icon>
            </button>
            <button mat-icon-button (click)="onEdit(element)" style="color:blue;" *ngIf="!rowInEditMode || element.id!==editBankInfo?.id"  matTooltip="Edit bank details">
                <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button (click)="onSaveChanges()" style="color:green;" *ngIf="rowInEditMode && element.id===editBankInfo?.id" matTooltip="Save bank details">
                <mat-icon>save</mat-icon>
            </button>
            <button mat-icon-button (click)="onCancelEdit()" style="color:red;" *ngIf="rowInEditMode && element.id===editBankInfo?.id" matTooltip="Cancel edit">
                <mat-icon>clear</mat-icon>
            </button>
            <button mat-icon-button color="primary">
                <mat-icon id="expand_more" (click)="expand(element)" #expand_more *ngIf="!element.close">expand_more</mat-icon>
                <mat-icon id="expand_less" (click)="expand(element)" #expand_less *ngIf="element.close">expand_less</mat-icon>
            </button>
        </mat-cell>
    </ng-container>
  <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
  <mat-row *matRowDef="let row; columns: displayedColumns;" class="element-row"
  [cdkDetailRow]="row" [cdkDetailRowTpl]="tpl" (toggleChange)="onToggleChange($event, row)">
  </mat-row>
</mat-table>

<mat-paginator *ngIf="!(isLoading$ | async)" #paginator [pageSize]="10" showFirstLastButtons></mat-paginator>

<ng-template #tpl let-element>
    <div fxLayout="column" [@detailExpand] style="overflow: hidden" class="mat-row" fxLayout.gt-md="row" fxLayoutGap.gt-md="20px" fxLayoutAlign="left center">
        <mat-card *ngFor="let account of element.accounts" class="card-detailed">
            <mat-card-header>
                <mat-card-title>Account name: {{ account.name }}</mat-card-title>
                <mat-card-subtitle>Account number: {{ account.number }}</mat-card-subtitle>
                <button mat-button (click)="select.open()"
                        *ngIf="account.isActive" matTooltip="more">
                        <mat-icon>more_vert</mat-icon>
                </button>
                <mat-select class="mat-select-options"
                        #select [(ngModel)]="accountAction">
                    <mat-option value="withdraw" (click)="onAccountAction(account)">Withdraw</mat-option>
                    <mat-option value="deposit" (click)="onAccountAction(account)">Deposit</mat-option>
                </mat-select>
            </mat-card-header>
            <mat-card-content>
                <div>
                    <span style="font-weight: bold;">Account status: </span>
                    <span *ngIf="account.isActive">Active</span>
                    <span *ngIf="!account.isActive">Inactive</span>
                </div>
                <div>
                    <span style="font-weight: bold;">Current balance: </span>
                    <span>{{ account.currentBalance | currency: account.accountCurrency }}</span>
                </div>
            </mat-card-content>
            <mat-card-actions>
                <button mat-button (click)="onEditAccount(account, element.isActive)">
                    <mat-icon>edit</mat-icon>
                    Edit
                </button>
                <button mat-button *ngIf="element.accounts.length > 1" (click)="onDeleteAccount(account)">
                    <mat-icon>delete</mat-icon>
                    Delete
                </button>
            </mat-card-actions>
        </mat-card>
	</div>
</ng-template>
